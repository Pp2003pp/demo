from xml.dom.expatbuilder import theDOMImplementation
import os
import time
import json
import requests
from typing import Optional

from django.conf import settings
from django.http import JsonResponse
from django.shortcuts import render, redirect
from django.views.decorators.csrf import csrf_exempt

from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib.auth.models import User
from django.contrib import messages
from django.db import IntegrityError

import google.generativeai as genai
from google.generativeai import configure

from .models import GithubToken

# ============================
# 1. User Registration/Login Views
# ============================

def register(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        confirm_password = request.POST.get('confirmPassword')
        email = request.POST.get('email')

        if password != confirm_password:
            messages.error(request, 'Passwords do not match. Please try again.')
            return render(request, 'review/register.html')

        if User.objects.filter(username=username).exists():
            messages.error(request, 'Username already taken. Please choose another one.')
            return render(request, 'review/register.html')

        if User.objects.filter(email=email).exists():
            messages.error(request, 'Email already registered. Please use a different email.')
            return render(request, 'review/register.html')

        try:
            user = User.objects.create_user(username=username, password=password, email=email)
            user.save()
            messages.success(request, 'Registration successful. Please log in.')
            print("User created")
            return redirect('login')
        except IntegrityError:
            messages.error(request, 'An error occurred during registration. Please try again.')
        except Exception as e:
            messages.error(request, f'Unexpected error: {e}')
            print("User not created")
    return render(request, 'review/register.html')


def login_view(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(request, username=username, password=password)

        if user is not None:
            login(request, user)
            messages.success(request, 'Login successful.')
            print("User login")
            return redirect('github_connect')
        else:
            messages.error(request, 'Invalid username or password. Please try again.')
            print("User not login")

    return render(request, 'review/login.html')


def logout_view(request):
    logout(request)
    messages.success(request, 'Logged out successfully.')
    return redirect('index')


def index(request):
    return render(request, 'review/home.html')


# ============================
# 2. GitHub OAuth Views
# ============================

@login_required
def github_connect(request):
    return render(request, 'review/connect.html')


def github_redirect(request):
    client_id = settings.GITHUB_CLIENT_ID
    redirect_uri = 'http://localhost:8000/oauth/callback/'
    github_url = f"https://github.com/login/oauth/authorize?client_id={client_id}&redirect_uri={redirect_uri}"
    return redirect(github_url)


def github_callback(request):
    code = request.GET.get('code')
    client_id = settings.GITHUB_CLIENT_ID
    client_secret = settings.GITHUB_CLIENT_SECRET
    token_url = 'https://github.com/login/oauth/access_token'

    response = requests.post(token_url, headers={'Accept': 'application/json'}, data={
        'client_id': client_id,
        'client_secret': client_secret,
        'code': code
    })

    token_data = response.json()
    access_token = token_data.get('access_token')

    GithubToken.objects.create(token=access_token)

    return render(request, 'review/success.html', {'token': access_token})


# ============================
# 3. GitHub Webhook & PR Review (Using Gemini)
# ============================

@csrf_exempt
def github_webhook(request):
    if request.method == 'POST':
        event = request.META.get('HTTP_X_GITHUB_EVENT')
        payload = request.body.decode('utf-8')

        # For pull request events, use the updated processing logic.
        if event == 'pull_request':
            process_pull_request(payload)

        return JsonResponse({'status': 'success'})
    return JsonResponse({'status': 'failure'}, status=400)


# Updated Process Pull Request Function:
# Instead of extracting only changed diff data, we now fetch the entire repository content.
def process_pull_request(payload):
    payload = json.loads(payload)
    pr_data = payload.get('pull_request', {})
    repo_full_name = payload.get('repository', {}).get('full_name')
    
    # Call the full repository review function
    review = review_entire_repository(repo_full_name)
    post_review_comment(pr_data, review)


# (Old diff-based functions are retained below in case you need them for other purposes)
def fetch_diff_from_github(diff_url):
    token = GithubToken.objects.first().token
    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3.diff"
    }
    response = requests.get(diff_url, headers=headers)
    if response.status_code == 200:
        return response.text
    else:
        print(f"Error fetching diff from GitHub: {response.status_code}")
        return "Error: Unable to fetch diff."


def call_huggingface_for_review(pr_title: str, pr_body: str, pr_diff: str) -> str:
    genai.configure(api_key=settings.GOOGLE_API_KEY)
    model = genai.GenerativeModel("gemini-1.5-flash")

    if not pr_body or pr_body.lower() == 'none':
        pr_body = "The pull request does not contain a description. Please review based on the title."

    prompt = f"""
    You are an AI code reviewer. Please analyze the following pull request:

    Title: {pr_title}
    Description: {pr_body}

    Code Changes (Diff):
    {pr_diff}

    Provide suggestions for improvements, highlight potential issues, and offer feedback.
    """

    print("Prompt being sent to Gemini API:")
    print(json.dumps({'prompt': prompt}, indent=4))

    try:
        response = model.generate_content(prompt)
        review_text = response.text.strip()
        review_text = clean_review_output(review_text)
        return review_text if review_text else "No review provided."
    except Exception as e:
        print(f"Unexpected error: {str(e)}")
        return f"Error: {str(e)}"


def clean_review_output(response_text):
    filtered_text = response_text.split("See also:")[0]
    return filtered_text.strip()


def post_review_comment(pr_data, review):
    pr_number = pr_data.get('number')
    repo_full_name = pr_data.get('base', {}).get('repo', {}).get('full_name')
    token = GithubToken.objects.first().token
    api_url = f"https://api.github.com/repos/{repo_full_name}/issues/{pr_number}/comments"

    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3+json"
    }

    data = {
        "body": review
    }

    response = requests.post(api_url, headers=headers, json=data)
    return response.status_code


# ============================
# 4. Other Views
# ============================

def home(request):
    return render(request, 'index.html')


def tutorial(request):
    return render(request, 'review/tutorial.html')


@login_required
def code_review(request):
    return render(request, 'review/code_review.html')


@csrf_exempt
def analyze_code(request):
    if request.method == 'POST':
        code_text = request.POST.get('code_text')
        code_file = request.FILES.get('code_file')

        if code_file:
            code_text = code_file.read().decode('utf-8')

        escaped_code_text = code_text.replace('\n', '\n').replace('\r', '\r')

        prompt = f"Analyze the following code for accuracy (score), optimization (score), and suggestions (text):\n\n{escaped_code_text}"
        ai_request = {
            "model": "gemini-1.5-flash",
            "prompt": prompt
        }

        try:
            model = genai.GenerativeModel(ai_request['model'])
            response = model.generate_content(ai_request['prompt'])
            analysis_text = response.candidates[0].content.parts[0].text if response.candidates else "No analysis available"
            return JsonResponse({"analysis": analysis_text})
        except Exception as e:
            print(f"Error in AI processing: {e}")
            return JsonResponse({"error": "An error occurred while processing the code."}, status=500)
    else:
        return JsonResponse({"error": "Invalid request method."}, status=405)


# ============================
# 5. Full Repository Review Functionality (Entire Repo Data)
# ============================

def fetch_full_repo_content(repo_full_name, default_branch='main'):
    token = GithubToken.objects.first().token
    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3+json"
    }

    branch_url = f"https://api.github.com/repos/{repo_full_name}/branches/{default_branch}"
    branch_response = requests.get(branch_url, headers=headers)
    if branch_response.status_code != 200:
        print(f"Error fetching branch info: {branch_response.status_code}")
        return {}

    tree_sha = branch_response.json()['commit']['commit']['tree']['sha']
    tree_url = f"https://api.github.com/repos/{repo_full_name}/git/trees/{tree_sha}?recursive=1"
    tree_response = requests.get(tree_url, headers=headers)
    if tree_response.status_code != 200:
        print(f"Error fetching tree: {tree_response.status_code}")
        return {}

    tree = tree_response.json().get('tree', [])
    files_content = {}

    for item in tree:
        if item['type'] == 'blob':
            file_path = item['path']
            # Skip binary or irrelevant files
            if any(file_path.endswith(ext) for ext in ['.png', '.jpg', '.jpeg', '.gif', '.pdf', '.ico']):
                continue
            if any(folder in file_path for folder in ['node_modules', 'venv', '.git']):
                continue

            raw_url = f"https://raw.githubusercontent.com/{repo_full_name}/{default_branch}/{file_path}"
            file_response = requests.get(raw_url, headers=headers)
            if file_response.status_code == 200:
                files_content[file_path] = file_response.text
            else:
                files_content[file_path] = f"Error fetching content (status {file_response.status_code})"

    return files_content


def review_entire_repository(repo_full_name):
    repo_data = fetch_full_repo_content(repo_full_name)
    
    # Print the full repository content for monitoring purposes
    print("===== Full Repository Content =====")
    print(json.dumps(repo_data, indent=2))
    print("===================================")
    
    if not repo_data:
        return "Error: Could not retrieve repository content."

    prompt = f"""
You are an expert AI code reviewer.

Below is the full source code of a GitHub repository, formatted as a dictionary where keys are file paths and values are file contents.

Your tasks:
1. Provide a detailed code quality review.
2. Identify improvements, bugs, or security issues.
3. Suggest best practices for performance, scalability, and readability.
4. Give an overall evaluation of the codebase.

Repository content:
{json.dumps(repo_data, indent=2)}
"""

    try:
        genai.configure(api_key=settings.GOOGLE_API_KEY)
        model = genai.GenerativeModel("gemini-1.5-flash")
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"Gemini API error: {e}")
        return f"Gemini API error: {e}"


@csrf_exempt
def full_repo_review(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body.decode('utf-8'))
            repo_full_name = data.get('repository', {}).get('full_name')
            if not repo_full_name:
                return JsonResponse({'error': 'Repository full name missing.'}, status=400)

            review = review_entire_repository(repo_full_name)
            return JsonResponse({'review': review}, status=200)
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=500)
    else:
        return JsonResponse({'error': 'Invalid request method.'}, status=405)
